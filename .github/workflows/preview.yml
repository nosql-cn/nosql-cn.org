name: PR Preview

on:
  pull_request:
    branches:
      - master
    types: [opened, synchronize, reopened]

jobs:
  preview:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: '0.148.2'
        extended: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build Hugo site
      run: hugo --environment production --minify
      env:
        HUGO_ENVIRONMENT: production

    - name: Upload preview artifacts
      uses: actions/upload-artifact@v4
      with:
        name: preview-site
        path: public/
        retention-days: 7

    - name: Add PR comment with build info
      uses: actions/github-script@v7
      with:
        script: |
          const { context } = require('@actions/github');
          const { execSync } = require('child_process');
          
          const pageCount = parseInt(execSync('find public -name "*.html" | wc -l').toString());
          const fileCount = parseInt(execSync('find public -type f | wc -l').toString());
          const size = execSync('du -sh public | cut -f1').toString().trim();
          
          const changedFiles = context.payload.pull_request.changed_files;
          const additions = context.payload.pull_request.additions;
          const deletions = context.payload.pull_request.deletions;
          
          let fileChanges = '';
          if (changedFiles > 0) {
            fileChanges = `
ğŸ“ **æ–‡ä»¶å˜æ›´**:
- ä¿®æ”¹æ–‡ä»¶æ•°: ${changedFiles}
- æ–°å¢è¡Œæ•°: ${additions}
- åˆ é™¤è¡Œæ•°: ${deletions}`;
          }
          
          const comment = `
          ğŸ¯ **PR æ„å»ºé¢„è§ˆ**
          
          âœ… **æ„å»ºæˆåŠŸ** ${fileChanges}
          
          ğŸ“Š **æ„å»ºç»Ÿè®¡**:
          - é¡µé¢æ•°: ${pageCount}
          - æ–‡ä»¶æ•°: ${fileCount}
          - æ€»å¤§å°: ${size}
          
          ğŸš€ **é¢„è§ˆæ–¹å¼**:
          1. ä¸‹è½½æ„å»ºäº§ç‰©ï¼ˆArtifactsï¼‰
          2. åœ¨æœ¬åœ°è¿è¡Œ \`hugo server\` é¢„è§ˆ
          
          âš¡ **è‡ªåŠ¨éƒ¨ç½²**:
          - PR åˆå¹¶åˆ° master åˆ†æ”¯åå°†è‡ªåŠ¨éƒ¨ç½²åˆ°: https://nosql-cn.org
          `;
          
          try {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('Comment already exists or failed to create:', error.message);
          }