name: Deploy Hugo Site to GitHub Pages

on:
  push:
    branches:
      - master
    paths:
      - 'content/**'
      - 'layouts/**'
      - 'static/**'
      - 'themes/**'
      - 'config/**'
      - '*.toml'
      - '*.yaml'
      - 'package.json'
      - 'postcss.config.js'
  pull_request:
    branches:
      - master
    paths:
      - 'content/**'
      - 'layouts/**'
      - 'static/**'
      - 'themes/**'
      - 'config/**'
      - '*.toml'
      - '*.yaml'
      - 'package.json'
      - 'postcss.config.js'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ï¼ˆä¸éƒ¨ç½²ï¼‰'
        required: false
        default: 'false'
        type: boolean

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/master' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.test_mode != 'true')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: '0.148.2'
        extended: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build Hugo site
      run: hugo --environment production --minify
      env:
        HUGO_ENVIRONMENT: production

    - name: Test build
      id: build-test
      run: |
        if [ ! -f "public/index.html" ]; then
          echo "âŒ Build failed: index.html not found"
          exit 1
        fi
        
        PAGE_COUNT=$(find public -name "*.html" | wc -l)
        FILE_COUNT=$(find public -type f | wc -l)
        TOTAL_SIZE=$(du -sh public | cut -f1)
        
        echo "âœ… Build successful"
        echo "ğŸ“Š Build statistics:"
        echo "   - HTML files: $PAGE_COUNT"
        echo "   - Total files: $FILE_COUNT"
        echo "   - Total size: $TOTAL_SIZE"
        
        # è®¾ç½®è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "page_count=$PAGE_COUNT" >> $GITHUB_OUTPUT
        echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
        echo "total_size=$TOTAL_SIZE" >> $GITHUB_OUTPUT

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        destination_dir: ./
        keep_files: true
        commit_message: 'ğŸ¤– è‡ªåŠ¨éƒ¨ç½²ç½‘ç«™æ›´æ–°

æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
è§¦å‘è€…: ${{ github.actor }}
æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}

æ„å»ºç»Ÿè®¡:
- é¡µé¢æ•°: ${{ steps.build-test.outputs.page_count }}
- æ–‡ä»¶æ•°: ${{ steps.build-test.outputs.file_count }}
- æ€»å¤§å°: ${{ steps.build-test.outputs.total_size }}

è§¦å‘æ–¹å¼: ${{ github.event_name }}'

  test-build:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: '0.148.2'
        extended: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build Hugo site (test)
      run: hugo --environment production --minify
      env:
        HUGO_ENVIRONMENT: production

    - name: Test build
      run: |
        if [ ! -f "public/index.html" ]; then
          echo "âŒ Build failed: index.html not found"
          exit 1
        fi
        echo "âœ… PR build test successful"
        echo "ğŸ“Š Build statistics:"
        echo "   - HTML files: $(find public -name "*.html" | wc -l)"
        echo "   - Total files: $(find public -type f | wc -l)"
        echo "   - Total size: $(du -sh public | cut -f1)"

    - name: Comment PR with build status
      uses: actions/github-script@v7
      with:
        script: |
          const { context } = require('@actions/github');
          const { execSync } = require('child_process');
          
          const pageCount = parseInt(execSync('find public -name "*.html" | wc -l').toString());
          const fileCount = parseInt(execSync('find public -type f | wc -l').toString());
          const size = execSync('du -sh public | cut -f1').toString().trim();
          
          const comment = `
          ğŸ¤– **Hugo æ„å»ºæµ‹è¯•ç»“æœ**
          
          âœ… **æ„å»ºæˆåŠŸ**
          
          ğŸ“Š **æ„å»ºç»Ÿè®¡**:
          - é¡µé¢æ•°: ${pageCount}
          - æ–‡ä»¶æ•°: ${fileCount}
          - æ€»å¤§å°: ${size}
          
          ğŸ¯ **ä¸‹ä¸€æ­¥**:
          - å¦‚æœ PR è¢«åˆå¹¶åˆ° master åˆ†æ”¯ï¼Œç½‘ç«™å°†è‡ªåŠ¨éƒ¨ç½²
          - éƒ¨ç½²åœ°å€: https://nosql-cn.org
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });