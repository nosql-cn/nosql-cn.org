name: Deploy Hugo Site to GitHub Pages

on:
  push:
    branches:
      - master
    paths:
      - 'content/**'
      - 'layouts/**'
      - 'static/**'
      - 'themes/**'
      - 'config/**'
      - '*.toml'
      - '*.yaml'
      - 'package.json'
      - 'postcss.config.js'
  pull_request:
    branches:
      - master
    paths:
      - 'content/**'
      - 'layouts/**'
      - 'static/**'
      - 'themes/**'
      - 'config/**'
      - '*.toml'
      - '*.yaml'
      - 'package.json'
      - 'postcss.config.js'
  workflow_dispatch:
    inputs:
      test_mode:
        description: '测试模式（不部署）'
        required: false
        default: 'false'
        type: boolean

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    if: (github.ref == 'refs/heads/master' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.test_mode != 'true')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: '0.148.2'
        extended: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build Hugo site
      run: hugo --environment production --minify
      env:
        HUGO_ENVIRONMENT: production

    - name: Test build
      id: build-test
      run: |
        if [ ! -f "public/index.html" ]; then
          echo "❌ Build failed: index.html not found"
          exit 1
        fi
        
        PAGE_COUNT=$(find public -name "*.html" | wc -l)
        FILE_COUNT=$(find public -type f | wc -l)
        TOTAL_SIZE=$(du -sh public | cut -f1)
        
        echo "✅ Build successful"
        echo "📊 Build statistics:"
        echo "   - HTML files: $PAGE_COUNT"
        echo "   - Total files: $FILE_COUNT"
        echo "   - Total size: $TOTAL_SIZE"
        
        # 设置输出变量供后续步骤使用
        echo "page_count=$PAGE_COUNT" >> $GITHUB_OUTPUT
        echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
        echo "total_size=$TOTAL_SIZE" >> $GITHUB_OUTPUT

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
        destination_dir: ./
        keep_files: true
        commit_message: '🤖 自动部署网站更新

构建时间: ${{ github.event.head_commit.timestamp }}
触发者: ${{ github.actor }}
提交信息: ${{ github.event.head_commit.message }}

构建统计:
- 页面数: ${{ steps.build-test.outputs.page_count }}
- 文件数: ${{ steps.build-test.outputs.file_count }}
- 总大小: ${{ steps.build-test.outputs.total_size }}

触发方式: ${{ github.event_name }}'

  test-build:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: '0.148.2'
        extended: true

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build Hugo site (test)
      run: hugo --environment production --minify
      env:
        HUGO_ENVIRONMENT: production

    - name: Test build
      run: |
        if [ ! -f "public/index.html" ]; then
          echo "❌ Build failed: index.html not found"
          exit 1
        fi
        echo "✅ PR build test successful"
        echo "📊 Build statistics:"
        echo "   - HTML files: $(find public -name "*.html" | wc -l)"
        echo "   - Total files: $(find public -type f | wc -l)"
        echo "   - Total size: $(du -sh public | cut -f1)"

    - name: Comment PR with build status
      uses: actions/github-script@v7
      with:
        script: |
          const { context } = require('@actions/github');
          const { execSync } = require('child_process');
          
          const pageCount = parseInt(execSync('find public -name "*.html" | wc -l').toString());
          const fileCount = parseInt(execSync('find public -type f | wc -l').toString());
          const size = execSync('du -sh public | cut -f1').toString().trim();
          
          const comment = `
          🤖 **Hugo 构建测试结果**
          
          ✅ **构建成功**
          
          📊 **构建统计**:
          - 页面数: ${pageCount}
          - 文件数: ${fileCount}
          - 总大小: ${size}
          
          🎯 **下一步**:
          - 如果 PR 被合并到 master 分支，网站将自动部署
          - 部署地址: https://nosql-cn.org
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });